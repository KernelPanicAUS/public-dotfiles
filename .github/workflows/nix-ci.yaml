name: "Test nix-darwin configuration"
on:
  pull_request:
  push:
    branches: ["master" ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build: # it has to be called build in order for github to recognise it as a status check
    runs-on: macos-latest
    timeout-minutes: 12
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: |
          accept-flake-config = true
          extra-experimental-features = nix-command flakes
    
    - name: Enable cached builds
      uses: DeterminateSystems/magic-nix-cache-action@main
    
    - name: Check flake inputs
      run: nix flake check
    
    - name: Build darwin system
      run: |
        nix build .#darwinConfigurations."trv4129-3".system
        
    # Optional: Check that the flake.lock is up to date
    - name: Check flake.lock
      run: |
        nix flake lock --no-update-lock-file
        
    # Optional: Show build closure size
    - name: Show closure size
      run: |
        nix path-info -Sh ./result

    # Optional: Cache Nix store between runs
    - uses: actions/cache@v4
      with:
        path: /nix
        key: ${{ runner.os }}-nix-${{ hashFiles('flake.lock') }}
        restore-keys: |
          ${{ runner.os }}-nix-
